<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–°–∂–∞—Ç–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –¥–æ 300 –ö–ë</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      max-width: 700px;
      margin: 40px auto;
      padding: 0 20px;
      background: #121212;
      color: #f0f0f0;
    }
    h1 {
      text-align: center;
      font-size: 1.8rem;
      margin-bottom: 30px;
    }
    .container {
      background: #1e1e1e;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    input, button, label {
      display: block;
      width: 100%;
      margin: 12px 0;
      padding: 10px;
      font-size: 1rem;
    }
    button {
      background: #dc2626; /* crimson */
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background: #b91c1c;
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    #result {
      margin-top: 20px;
      text-align: center;
    }
    #downloadBtn {
      display: none;
      margin-top: 15px;
      background: #22c55e;
    }
    #downloadBtn:hover {
      background: #16a34a;
    }
    img.preview {
      max-width: 100%;
      max-height: 300px;
      margin-top: 15px;
      border-radius: 8px;
      display: none;
    }
  </style>
</head>
<body>
  <h1>üñºÔ∏è –°–∂–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞</h1>
  <div class="container">
    <label for="imageInput">–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ:</label>
    <input type="file" id="imageInput" accept="image/*" />

    <label for="targetSize">–¶–µ–ª–µ–≤–æ–π —Ä–∞–∑–º–µ—Ä (–ö–ë):</label>
    <input type="number" id="targetSize" value="300" min="10" max="5000" />

    <button id="compressBtn" disabled>–°–∂–∞—Ç—å</button>

    <div id="result">
      <img id="preview" class="preview" alt="–°–∂–∞—Ç–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ" />
      <p id="status"></p>
      <a id="downloadBtn" download="compressed.jpg">üíæ –°–∫–∞—á–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</a>
    </div>
  </div>

  <script>
    const imageInput = document.getElementById('imageInput');
    const compressBtn = document.getElementById('compressBtn');
    const targetSizeInput = document.getElementById('targetSize');
    const preview = document.getElementById('preview');
    const status = document.getElementById('status');
    const downloadBtn = document.getElementById('downloadBtn');

    let originalFile = null;

    imageInput.addEventListener('change', (e) => {
      originalFile = e.target.files[0];
      compressBtn.disabled = !originalFile;
      if (originalFile) {
        status.textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ: ${Math.round(originalFile.size / 1024)} –ö–ë`;
      }
    });

    compressBtn.addEventListener('click', async () => {
      if (!originalFile) return;

      const targetKB = Number(targetSizeInput.value);
      if (isNaN(targetKB) || targetKB <= 0) {
        alert('–£–∫–∞–∂–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–∞–∑–º–µ—Ä –≤ –ö–ë.');
        return;
      }

      const targetBytes = targetKB * 1024;

      status.textContent = '–û–±—Ä–∞–±–æ—Ç–∫–∞...';
      downloadBtn.style.display = 'none';
      preview.style.display = 'none';

      const compressedBlob = await compressImageToFileSize(originalFile, targetBytes);

      if (compressedBlob) {
        const url = URL.createObjectURL(compressedBlob);
        preview.src = url;
        preview.style.display = 'inline';
        status.textContent = `–†–µ–∑—É–ª—å—Ç–∞—Ç: ${(compressedBlob.size / 1024).toFixed(1)} –ö–ë`;
        downloadBtn.href = url;
        downloadBtn.style.display = 'inline-block';
      } else {
        status.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∂–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–æ –∑–∞–¥–∞–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞.';
      }
    });

    async function compressImageToFileSize(file, targetSizeBytes, maxAttempts = 20) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');

            let width = img.width;
            let height = img.height;
            let quality = 0.95; // –Ω–∞—á–∞–ª—å–Ω–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ (95%)
            let scale = 1.0;

            for (let attempt = 0; attempt < maxAttempts; attempt++) {
              // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä —Ö–æ–ª—Å—Ç–∞
              const newWidth = Math.floor(width * scale);
              const newHeight = Math.floor(height * scale);
              canvas.width = newWidth;
              canvas.height = newHeight;

              // –†–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ–º
              ctx.clearRect(0, 0, newWidth, newHeight);
              ctx.drawImage(img, 0, 0, newWidth, newHeight);

              // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ Blob
              canvas.toBlob(
                (blob) => {
                  if (blob.size <= targetSizeBytes) {
                    resolve(blob);
                  } else {
                    // –ù–µ —É–ª–æ–∂–∏–ª–∏—Å—å ‚Äî –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
                    if (quality > 0.1) {
                      quality -= 0.05;
                    } else {
                      // –ö–∞—á–µ—Å—Ç–≤–æ —É–∂–µ –Ω–∏–∑–∫–æ–µ ‚Äî —É–º–µ–Ω—å—à–∞–µ–º –º–∞—Å—à—Ç–∞–±
                      scale *= 0.9;
                      quality = 0.95;
                    }
                    // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ü–∏–∫–ª —á–µ—Ä–µ–∑ –∑–∞–º—ã–∫–∞–Ω–∏–µ
                    // –ù–æ —Ç–∞–∫ –∫–∞–∫ –º—ã –≤ async, –ø—Ä–æ—Å—Ç–æ "—Ä–µ–∫—É—Ä—Å–∏–º" —á–µ—Ä–µ–∑ —Å–ª–µ–¥—É—é—â—É—é –∏—Ç–µ—Ä–∞—Ü–∏—é
                    // –ó–¥–µ—Å—å –ø—Ä–æ—â–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ü–∏–∫–ª —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π —á–µ—Ä–µ–∑ resolve/reject ‚Äî –Ω–æ –º—ã –≤ Promise
                    // –ü–æ—ç—Ç–æ–º—É –¥–µ–ª–∞–µ–º —Ö–∞–∫: –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É —Å –Ω–æ–≤—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
                    // –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ ‚Äî –≤—ã–Ω–µ—Å–µ–º –ª–æ–≥–∏–∫—É –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é —Å —Ä–µ–∫—É—Ä—Å–∏–µ–π
                  }
                },
                'image/jpeg',
                quality
              );
            }

            // –ï—Å–ª–∏ –≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π blob (–¥–∞–∂–µ –µ—Å–ª–∏ –±–æ–ª—å—à–µ)
            // –ù–æ –∏–∑-–∑–∞ –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç–∏ —ç—Ç–æ —Å–ª–æ–∂–Ω–æ. –ü–æ—ç—Ç–æ–º—É –ª—É—á—à–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ä–µ–∫—É—Ä—Å–∏—é:

            // –ü–µ—Ä–µ–ø–∏—à–µ–º –≤–Ω—É—Ç—Ä–∏ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ:
            function tryCompress(currentQuality, currentScale, attempt) {
  // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è "–¥–æ –∫–æ—Ç–æ—Ä—ã—Ö –º–æ–∂–Ω–æ –æ–ø—É—Å–∫–∞—Ç—å—Å—è"
  const MIN_QUALITY = 0.05;     // –Ω–∏–∂–µ ‚Äî –ø–æ—á—Ç–∏ –±–µ—Å–ø–æ–ª–µ–∑–Ω–æ
  const MIN_SCALE = 0.1;        // 10% –æ—Ç –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 4000px ‚Üí 400px ‚Äî —É–∂–µ –º–∞–ª–æ)

  const newWidth = Math.max(1, Math.floor(width * currentScale));
  const newHeight = Math.max(1, Math.floor(height * currentScale));

  canvas.width = newWidth;
  canvas.height = newHeight;
  ctx.clearRect(0, 0, newWidth, newHeight);
  ctx.drawImage(img, 0, 0, newWidth, newHeight);

  canvas.toBlob((blob) => {
    if (blob.size <= targetSizeBytes) {
      resolve(blob); // ‚úÖ –¶–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!
      return;
    }

    // –ï—Å–ª–∏ —É–∂–µ –Ω–∞ –º–∏–Ω–∏–º—É–º–µ ‚Äî –±–æ–ª—å—à–µ —Å–∂–∏–º–∞—Ç—å –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω–æ
    if (currentQuality <= MIN_QUALITY && currentScale <= MIN_SCALE) {
      console.warn('–î–æ—Å—Ç–∏–≥–Ω—É—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä. –¶–µ–ª–µ–≤–æ–π —Ä–∞–∑–º–µ—Ä –Ω–µ–¥–æ—Å—Ç–∏–∂–∏–º.');
      resolve(blob); // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –≤—Å—ë, —á—Ç–æ –µ—Å—Ç—å
      return;
    }

    // –°–Ω–∞—á–∞–ª–∞ —Å–Ω–∏–∂–∞–µ–º –∫–∞—á–µ—Å—Ç–≤–æ
    if (currentQuality > MIN_QUALITY) {
      tryCompress(currentQuality - 0.05, currentScale);
    } else {
      // –ö–∞—á–µ—Å—Ç–≤–æ –Ω–∞ –º–∏–Ω–∏–º—É–º–µ ‚Äî —É–º–µ–Ω—å—à–∞–µ–º –º–∞—Å—à—Ç–∞–±
      const nextScale = currentScale * 0.9;
      if (nextScale >= MIN_SCALE) {
        tryCompress(MIN_QUALITY, nextScale); // –∫–∞—á–µ—Å—Ç–≤–æ –æ—Å—Ç–∞–≤–ª—è–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º
      } else {
        // –ò –º–∞—Å—à—Ç–∞–± —Ç–æ–∂–µ –Ω–∞ –º–∏–Ω–∏–º—É–º–µ ‚Äî —Å–¥–∞—ë–º—Å—è
        resolve(blob);
      }
    }
  }, 'image/jpeg', currentQuality);
}

            tryCompress(0.95, 1.0, 0);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }
  </script>
</body>
</html>